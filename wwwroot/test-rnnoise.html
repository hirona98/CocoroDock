<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNNoise Processor Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.warning { background-color: #fff3cd; color: #856404; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }

        .settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #555;
        }

        input[type="range"] {
            width: 100%;
        }

        .value-display {
            font-size: 12px;
            color: #777;
        }

        .audio-visualization {
            height: 100px;
            background: linear-gradient(to right, #e3f2fd, #2196f3);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }

        .audio-level-bar {
            height: 100%;
            background: linear-gradient(to right, #4caf50, #ffeb3b, #f44336);
            transition: width 0.1s ease;
            border-radius: 8px;
        }

        .vad-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            transition: all 0.3s;
        }

        .vad-indicator.speech {
            background-color: #4caf50;
            animation: pulse 1s infinite;
        }

        .vad-indicator.silence {
            background-color: #757575;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.error {
            color: #dc3545;
            font-weight: bold;
        }

        .recorded-audio {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }

            .settings {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎤 RNNoise Processor Test</h1>

        <div id="status" class="status info">
            初期化待機中...
        </div>

        <div class="controls">
            <button id="initBtn" class="btn-primary">初期化</button>
            <button id="startBtn" class="btn-success" disabled>録音開始</button>
            <button id="stopBtn" class="btn-danger" disabled>録音停止</button>
            <button id="testBtn" class="btn-warning" disabled>音声テスト</button>
            <button id="debugBtn" class="btn-primary">デバッグ切替</button>
            <button id="clearLogBtn" class="btn-warning">ログクリア</button>
        </div>

        <div class="settings">
            <div class="setting-item">
                <label for="vadThreshold">VAD閾値</label>
                <input type="range" id="vadThreshold" min="0" max="1" step="0.01" value="0.6">
                <div class="value-display" id="vadThresholdValue">0.6</div>
            </div>

            <div class="setting-item">
                <label for="silenceTimeout">無音タイムアウト (ms)</label>
                <input type="range" id="silenceTimeout" min="100" max="2000" step="50" value="500">
                <div class="value-display" id="silenceTimeoutValue">500ms</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>📊 リアルタイム音声可視化</h2>
        <div class="audio-visualization">
            <div id="audioLevelBar" class="audio-level-bar" style="width: 0%;"></div>
            <div id="vadIndicator" class="vad-indicator silence">無音</div>
        </div>
    </div>

    <div class="container">
        <h2>📈 統計情報</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">処理フレーム数</div>
                <div class="stat-value" id="framesProcessed">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">音声セグメント数</div>
                <div class="stat-value" id="voiceSegments">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">総音声時間</div>
                <div class="stat-value" id="totalVoiceTime">0ms</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">平均VAD確率</div>
                <div class="stat-value" id="avgVadProb">0%</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>🎵 録音された音声</h2>
        <div id="recordedAudioContainer">
            まだ音声が録音されていません。
        </div>
    </div>

    <div class="container">
        <h2>📝 ログ</h2>
        <div id="logContainer" class="log-container">
            ログが表示されます...
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // rnnoise.jsをESモジュールとして読み込み、グローバル変数に設定
        import createRNNWasmModule from '/js/rnnoise.js';
        window.createRNNWasmModule = createRNNWasmModule;
    </script>
    <script src="/js/rnnoise-processor.js"></script>
    <script>
        // グローバル変数
        let processor = null;
        let audioContext = null;
        let mediaStream = null;
        let sourceNode = null;
        let processorNode = null;
        let isRecording = false;
        let recordedSegmentCount = 0;

        // DOM要素
        const elements = {
            status: document.getElementById('status'),
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            testBtn: document.getElementById('testBtn'),
            debugBtn: document.getElementById('debugBtn'),
            clearLogBtn: document.getElementById('clearLogBtn'),
            vadThreshold: document.getElementById('vadThreshold'),
            silenceTimeout: document.getElementById('silenceTimeout'),
            vadThresholdValue: document.getElementById('vadThresholdValue'),
            silenceTimeoutValue: document.getElementById('silenceTimeoutValue'),
            audioLevelBar: document.getElementById('audioLevelBar'),
            vadIndicator: document.getElementById('vadIndicator'),
            logContainer: document.getElementById('logContainer'),
            recordedAudioContainer: document.getElementById('recordedAudioContainer'),
            framesProcessed: document.getElementById('framesProcessed'),
            voiceSegments: document.getElementById('voiceSegments'),
            totalVoiceTime: document.getElementById('totalVoiceTime'),
            avgVadProb: document.getElementById('avgVadProb')
        };

        // イベントリスナー設定
        function setupEventListeners() {
            elements.initBtn.addEventListener('click', initializeProcessor);
            elements.startBtn.addEventListener('click', startRecording);
            elements.stopBtn.addEventListener('click', stopRecording);
            elements.testBtn.addEventListener('click', runAudioTest);
            elements.debugBtn.addEventListener('click', toggleDebugMode);
            elements.clearLogBtn.addEventListener('click', clearLog);

            elements.vadThreshold.addEventListener('input', updateVADThreshold);
            elements.silenceTimeout.addEventListener('input', updateSilenceTimeout);

            // 設定値の初期表示
            updateVADThreshold();
            updateSilenceTimeout();
        }

        // 初期化処理
        async function initializeProcessor() {
            updateStatus('初期化中...', 'info');
            elements.initBtn.disabled = true;

            try {
                processor = new RNNoiseProcessor();

                // イベントハンドラー設定
                processor.onInitialized = () => {
                    updateStatus('初期化完了！録音を開始できます。', 'success');
                    elements.startBtn.disabled = false;
                    elements.testBtn.disabled = false;
                };

                processor.onVoiceDetected = () => {
                    log('🎤 音声開始検出');
                };

                processor.onVoiceEnded = (audioFrames) => {
                    log(`🔊 音声終了: ${audioFrames.length}フレーム`);
                    handleRecordedAudio(audioFrames);
                };

                processor.onAudioLevel = (level, isSpeech, vadProb) => {
                    updateVisualization(level, isSpeech, vadProb);
                };

                processor.onError = (error) => {
                    log(`❌ エラー: ${error.message}`, 'error');
                    updateStatus(`エラー: ${error.message}`, 'error');
                };

                processor.setDebugMode(true);

                // 初期化実行
                const success = await processor.initialize();
                if (!success) {
                    throw new Error('初期化に失敗しました');
                }

            } catch (error) {
                log(`❌ 初期化エラー: ${error.message}`, 'error');
                updateStatus(`初期化失敗: ${error.message}`, 'error');
                elements.initBtn.disabled = false;
            }
        }

        // 録音開始
        async function startRecording() {
            if (isRecording || !processor) return;

            try {
                updateStatus('マイクアクセスを要求中...', 'info');

                // マイクアクセス
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 48000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                // AudioContext設定
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 48000
                });

                await audioContext.resume();

                // オーディオノード作成
                sourceNode = audioContext.createMediaStreamSource(mediaStream);
                processorNode = audioContext.createScriptProcessor(4096, 1, 1);

                // 音声処理
                processorNode.onaudioprocess = (audioProcessingEvent) => {
                    const inputBuffer = audioProcessingEvent.inputBuffer;
                    const inputData = inputBuffer.getChannelData(0);

                    // 480サンプル（10ms）ずつ処理
                    for (let i = 0; i < inputData.length; i += 480) {
                        const frame = inputData.slice(i, i + 480);
                        if (frame.length === 480) {
                            processor.processAudioFrame(frame);
                        }
                    }
                };

                // ノード接続
                sourceNode.connect(processorNode);
                processorNode.connect(audioContext.destination);

                isRecording = true;
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
                updateStatus('録音中... 話してください！', 'success');
                log('🎤 録音開始');

            } catch (error) {
                log(`❌ 録音開始エラー: ${error.message}`, 'error');
                updateStatus(`録音開始失敗: ${error.message}`, 'error');
            }
        }

        // 録音停止
        function stopRecording() {
            if (!isRecording) return;

            try {
                // ストリーム停止
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                // ノード切断
                if (sourceNode) {
                    sourceNode.disconnect();
                    sourceNode = null;
                }

                if (processorNode) {
                    processorNode.disconnect();
                    processorNode = null;
                }

                // AudioContext終了
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                    audioContext = null;
                }

                isRecording = false;
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                updateStatus('録音停止しました。', 'info');
                log('🛑 録音停止');

                // 可視化リセット
                elements.audioLevelBar.style.width = '0%';
                elements.vadIndicator.textContent = '無音';
                elements.vadIndicator.className = 'vad-indicator silence';

            } catch (error) {
                log(`❌ 録音停止エラー: ${error.message}`, 'error');
            }
        }

        // 音声テスト（合成音声）
        function runAudioTest() {
            if (!processor) return;

            log('🧪 音声テスト開始');
            updateStatus('音声テスト中...', 'info');

            // テスト用正弦波生成（1秒間、440Hz）
            const sampleRate = 48000;
            const duration = 1.0;
            const frequency = 440;
            const frameSize = 480;
            const totalFrames = Math.floor(sampleRate * duration / frameSize);

            let frameIndex = 0;
            const testInterval = setInterval(() => {
                if (frameIndex >= totalFrames) {
                    clearInterval(testInterval);
                    updateStatus('音声テスト完了', 'success');
                    log('✅ 音声テスト完了');
                    return;
                }

                // 正弦波フレーム生成
                const frame = new Float32Array(frameSize);
                for (let i = 0; i < frameSize; i++) {
                    const t = (frameIndex * frameSize + i) / sampleRate;
                    frame[i] = Math.sin(2 * Math.PI * frequency * t) * 0.3;
                }

                processor.processAudioFrame(frame);
                frameIndex++;
            }, 10); // 10ms間隔
        }

        // デバッグモード切替
        function toggleDebugMode() {
            if (!processor) return;

            const currentMode = processor.debugMode;
            processor.setDebugMode(!currentMode);
            elements.debugBtn.textContent = processor.debugMode ? 'デバッグOFF' : 'デバッグON';
            log(`🐛 デバッグモード: ${processor.debugMode ? 'ON' : 'OFF'}`);
        }

        // ログクリア
        function clearLog() {
            elements.logContainer.innerHTML = '';
            if (processor) {
                processor.clearDebugLog();
            }
            log('📝 ログクリア');
        }

        // VAD閾値更新
        function updateVADThreshold() {
            const value = parseFloat(elements.vadThreshold.value);
            elements.vadThresholdValue.textContent = value.toFixed(2);

            if (processor) {
                processor.setVADThreshold(value);
            }
        }

        // 無音タイムアウト更新
        function updateSilenceTimeout() {
            const value = parseInt(elements.silenceTimeout.value);
            elements.silenceTimeoutValue.textContent = value + 'ms';

            if (processor) {
                processor.setSilenceTimeout(value);
            }
        }

        // 可視化更新
        function updateVisualization(level, isSpeech, vadProb) {
            // 音声レベルバー
            elements.audioLevelBar.style.width = (level * 100) + '%';

            // VADインジケーター
            if (isSpeech) {
                elements.vadIndicator.textContent = `音声 (${(vadProb * 100).toFixed(1)}%)`;
                elements.vadIndicator.className = 'vad-indicator speech';
            } else {
                elements.vadIndicator.textContent = `無音 (${(vadProb * 100).toFixed(1)}%)`;
                elements.vadIndicator.className = 'vad-indicator silence';
            }

            // 統計情報更新
            if (processor) {
                const stats = processor.getStats();
                elements.framesProcessed.textContent = stats.framesProcessed;
                elements.voiceSegments.textContent = stats.voiceSegments;
                elements.totalVoiceTime.textContent = stats.totalVoiceTime + 'ms';
                elements.avgVadProb.textContent = (stats.averageVadProbability * 100).toFixed(1) + '%';
            }
        }

        // 録音された音声処理
        function handleRecordedAudio(audioFrames) {
            recordedSegmentCount++;

            const wavData = processor.convertToWav(audioFrames);
            if (!wavData) {
                log('❌ WAV変換に失敗', 'error');
                return;
            }

            // 音声再生用要素作成
            const audioBlob = new Blob([wavData], { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);

            const audioDiv = document.createElement('div');
            audioDiv.className = 'recorded-audio';
            audioDiv.innerHTML = `
                <h4>🎵 録音セグメント #${recordedSegmentCount}</h4>
                <p>フレーム数: ${audioFrames.length}, 時間: ${audioFrames.length * 10}ms</p>
                <audio controls src="${audioUrl}"></audio>
                <button onclick="downloadAudio('${audioUrl}', 'voice_${recordedSegmentCount}.wav')">ダウンロード</button>
            `;

            elements.recordedAudioContainer.appendChild(audioDiv);
            elements.recordedAudioContainer.scrollTop = elements.recordedAudioContainer.scrollHeight;

            log(`💾 音声セグメント #${recordedSegmentCount} 保存完了`);
        }

        // 音声ダウンロード
        function downloadAudio(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // ステータス更新
        function updateStatus(message, type) {
            elements.status.textContent = message;
            elements.status.className = `status ${type}`;
        }

        // ログ出力
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;

            elements.logContainer.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', setupEventListeners);

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (processor) {
                processor.destroy();
            }
            if (isRecording) {
                stopRecording();
            }
        });
    </script>
</body>
</html>